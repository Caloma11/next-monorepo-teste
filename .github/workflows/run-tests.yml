name: cypress e2e
on:
  push:
    branches:    
      - 'master'
    paths:
      - 'packages/**'
      - '!packages/shared/**'

jobs:
  install:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Save build folder
          uses: actions/upload-artifact@v2
          with:
            name: build
            if-no-files-found: error
            path: build

        - name: Cypress install
          uses: cypress-io/github-action@v2
          with:
            # Disable running of tests within install job
            runTests: false
            build: yarn build

  cypress-run:
    runs-on: ubuntu-latest
    needs: install
    strategy:
      # tells cypress to not stop other running instances if one fails
      fail-fast: false
      # runs in parallel
      matrix:
        cypress:
          - working_directory: packages/login
          - working_directory: packages/web-app
    steps: 
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Download the build folders
        uses: actions/download-artifact@v2
        with:
          name: build
          path: build
      
      - name: Run tests
        uses: cypress-io/github-action@v2
        with:
          working-directory: ${{ matrix.cypress.working_directory }}
          start: yarn run start
          parallel: true